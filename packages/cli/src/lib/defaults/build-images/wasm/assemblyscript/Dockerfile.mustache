FROM node:{{node_version}}-alpine as base

RUN apk --no-cache --virtual build-dependencies add bash

{{#web3api_linked_packages.length}}
WORKDIR /linked-packages
{{/web3api_linked_packages.length}}

{{#web3api_linked_packages}}
COPY {{dir}} ./{{name}}
{{/web3api_linked_packages}}

WORKDIR /project

# Install deps in its own step, making rebuilds faster
# when just the Web3API schema & implementation files change
COPY package.json .
{{#web3api_linked_packages}}
RUN npx json -I -f package.json -e "this.dependencies['{{name}}']='../linked-packages/{{name}}'"
{{/web3api_linked_packages}}
RUN yarn

# Copy all manifest files
{{#web3api_manifests}}
COPY {{.}} .
{{/web3api_manifests}}

# Copy all source files
{{#include}}
COPY {{.}} {{.}}
{{/include}}
{{#web3api_module}}
COPY {{dir}} {{dir}}

# Build the module at {{dir}}
RUN ./node_modules/.bin/asc {{dir}}/polywrap/entry.ts \
    --path ./node_modules \
    --outFile ./build/{{name}}.wasm \
    --use abort={{dir}}/polywrap/entry/wrapAbort \
    --optimize --importMemory \
    --runtime stub \
    --runPasses asyncify \
    --transform @serial-as/transform
{{/web3api_module}}
